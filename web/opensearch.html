<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Search EU Law</title>
  <style>
    :root {
      --primary-color: #0056b3;
      --primary-hover-color: #004494;
      --light-gray: #f8f9fa;
      --medium-gray: #dee2e6;
      --dark-gray: #495057;
      --text-color: #212529;
      --link-color: #0056b3;
      --highlight-bg: #ffe066;
      --white: #ffffff;
      --danger-color: #dc3545;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--light-gray);
      color: var(--text-color);
      margin: 0;
      padding: 0 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
      background-color: var(--white);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .header-info {
      background-color: #e9ecef;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 25px;
      font-size: 0.9rem;
      color: var(--dark-gray);
    }
    .header-info div {
      margin-bottom: 8px;
    }
    .header-info div:last-child {
      margin-bottom: 0;
    }
    .header-info a {
      color: var(--primary-color);
      font-weight: 500;
    }

    h2 {
      color: var(--dark-gray);
      border-bottom: 1px solid var(--medium-gray);
      padding-bottom: 10px;
      margin-top: 0;
    }

    .search-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    input[type=text] {
      flex-grow: 1;
      padding: 10px 15px;
      font-size: 1rem;
      border: 1px solid var(--medium-gray);
      border-radius: 6px;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input[type=text]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.2);
    }

    button {
      padding: 10px 15px;
      font-size: 0.9rem;
      border-radius: 6px;
      border: 1px solid transparent;
      cursor: pointer;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
      font-weight: 500;
    }

    #searchBtn1, #searchBtn2, #searchBtn3 {
      background-color: var(--primary-color);
      color: var(--white);
    }
    #searchBtn1:hover, #searchBtn2:hover, #searchBtn3:hover {
      background-color: var(--primary-hover-color);
    }

    #clearBtn {
      background-color: #6c757d;
      color: var(--white);
    }
    #clearBtn:hover {
      background-color: #5a6268;
    }

    table {
      border-collapse: collapse;
      margin-top: 18px;
      width: 100%;
      font-size: 0.9rem;
    }

    th,
    td {
      padding: 12px 15px;
      text-align: left;
      word-wrap: break-word;
      border-bottom: 1px solid var(--medium-gray);
    }

    th {
      background-color: var(--light-gray);
      font-weight: 600;
      color: var(--dark-gray);
    }

    tbody tr:nth-child(even) {
      background-color: var(--light-gray);
    }

    tbody tr:hover {
      background-color: #e9ecef;
    }

    td a {
      color: var(--link-color);
      font-weight: 500;
      text-decoration: none;
    }
    td a:hover {
      text-decoration: underline;
    }

    mark {
      background: var(--highlight-bg);
      font-weight: 600;
      padding: 1px 3px;
      border-radius: 3px;
    }

    .muted {
      color: #666;
      font-size: 0.9rem;
      text-align: center;
      padding: 40px 0;
    }

    pre[style*="color:darkred"] {
      background-color: #f8d7da;
      color: #721c24 !important;
      border: 1px solid #f5c6cb;
      padding: 15px;
      border-radius: 6px;
      white-space: pre-wrap;
    }

    #userInfoBox {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 12px;
      background-color: #fff;
      border: 1px solid var(--medium-gray);
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.75rem;
      color: var(--dark-gray);
      z-index: 1000;
      max-width: 250px;
      word-wrap: break-word;
    }
    #userInfoBox div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>

<body>
  <div id="userInfoBox">Loading user info...</div>
  <div class="container">
    <div class="header-info">
      <div><strong>Limited Trial Version</strong></div>
      <div>Full-text access to the European Union's legal texts, currently in English, Slovak and Czech, with other languages to follow soon.</div>
      <div>EU Law data reused under <a href="https://eur-lex.europa.eu/content/help/data-reuse/reuse-contents-eurlex-details.html" target="_blank" rel="noopener noreferrer">these terms.</a></div>
      <div>Full version available upon subscription. Includes advanced toolbox for linguists working with EU Law including automated on-the-fly content analysis, creating project-specific resources and integration with CAT tools.</div>
      <div>To obtain the full version visit <a href="https://www.pts-translation.sk/" target="_blank" rel="noopener noreferrer">this page</a>.</div>
    </div>

    <h2>Search EU Law</h2>

    <div class="search-controls">
      <input id="q" type="text" placeholder="Enter search phrase..." />
      <button id="searchBtn1" title="Performs a precise phrase search on English text.">Search (English only)</button>
      <button id="searchBtn2" title="Performs a fuzzy search across English, Slovak, and Czech.">Search (EN, SK, CZ)</button>
      <button id="searchBtn3" title="Combines phrase and fuzzy matching across all three languages.">Search (Combined)</button>
      <button id="clearBtn">Clear</button>
    </div>
    <div style="margin-top: 10px; font-size: 0.9rem;">
      <input type="checkbox" id="highlightToggle" checked style="vertical-align: middle;">
      <label for="highlightToggle" style="vertical-align: middle;">Highlight results</label>
    </div>

    <div id="results" style="margin-top: 25px;"></div>
  </div>

  <script>
    const OPENSEARCH_URL = 'https://search.pts-translation.sk';
    const DEFAULT_INDEX = '_all';
    
    let userIP = 'N/A';
    let userFingerprint = 'N/A';

    const qInput = document.getElementById('q');
    const resultsDiv = document.getElementById('results');

    document.getElementById('searchBtn1').addEventListener('click', () => doSearch("phraseBoost"));
    document.getElementById('searchBtn2').addEventListener('click', () => doSearch("multiFuzzy"));
    document.getElementById('searchBtn3').addEventListener('click', () => doSearch("combined"));
    document.getElementById('clearBtn').addEventListener('click', () => { qInput.value = ''; resultsDiv.innerHTML = ''; });

    qInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') doSearch("phraseBoost"); });

    async function doSearch(mode) {
      const q = qInput.value.trim();
      const index = DEFAULT_INDEX;

      // Prepare the client context for logging and quota management
      const clientContext = {
        ip: userIP,
        fingerprint: userFingerprint,
        timestamp: new Date().toISOString(),
        query: q
      };

      let body;
      if (!q) { // No search term, show all
        body = { size: 50, query: { match_all: {} } };
      } else if (mode === "phraseBoost") {
        body = {
          query: {
            bool: {
              must: [
                { match_phrase: { en_text: { query: q, slop: 2, boost: 1.5 } } },
                { term: { paragraphsNotMatched: false } }
              ]
            }
          },
          size: 50,
          "collapse": { "field": "dir_id.keyword" }
        };
      } else if (mode === "multiFuzzy") {
        body = {
          query: {
            bool: {
              must: [
                {
                  multi_match: {
                    query: q,
                    fields: ["en_text", "sk_text", "cz_text"],
                    fuzziness: 1,
                    minimum_should_match: "80%"
                  }
                },
                { term: { paragraphsNotMatched: false } }
              ]
            }
          },
          size: 50,
          "collapse": { "field": "dir_id.keyword" }
        };
      } else if (mode === "combined") {
        body = {
          query: {
            bool: {
              should: [
                { match_phrase: { en_text: { query: q, slop: 2, boost: 3.0 } } },
                { match: { en_text: { query: q, fuzziness: 1, operator: "and", boost: 1.0 } } },
                { match_phrase: { sk_text: { query: q, slop: 2, boost: 3.0 } } },
                { match: { sk_text: { query: q, fuzziness: 1, operator: "and", boost: 1.0 } } },
                { match_phrase: { cz_text: { query: q, slop: 2, boost: 3.0 } } },
                { match: { cz_text: { query: q, fuzziness: 1, operator: "and", boost: 1.0 } } }
              ],
              minimum_should_match: 1
            }
          },
          size: 25,
          "collapse": { "field": "dir_id.keyword" }
        };
      }

      resultsDiv.innerHTML = '<p class="muted">Searchingâ€¦</p>';

      try {
        const url = `${OPENSEARCH_URL}/${encodeURIComponent(index)}/_search`;
        const headers = {
          'Content-Type': 'application/json',
          'x-client-context': JSON.stringify(clientContext), // Add context as a header
          'x-api-key': '1234'
        };
        const resp = await fetch(url, { method: 'POST', headers, body: JSON.stringify(body) });
        const data = await resp.json();
        renderResults(data, q);
      } catch (err) {
        resultsDiv.innerHTML = `<pre style="color:darkred">Error:\n${escapeHtml(String(err))}</pre>`;
      }
    }

    function renderResults(data, query) {
      const hits = (data.hits?.hits || []).filter(h => {
        const src = h._source || {};
        if (src.class === "NotMatch") return false;
        if (src.paragraphsNotMatched !== false) return false;
        return true;
      });

      if (hits.length === 0) {
        resultsDiv.innerHTML = '<p class="muted">No results</p>';
        return;
      }

      const fieldMap = {
        "en_text": "English",
        "sk_text": "Slovak",
        "cz_text": "Czech",
        "celex": "Full Document"
      };
      const fields = Object.keys(fieldMap);
      const headers = Object.values(fieldMap);

      let html = '<table><thead><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr></thead><tbody>';

      for (const h of hits) { // Loop through each search result hit
        const src = h._source || {};
        html += '<tr>' + fields.map(f => {
          if (f === "celex") {
            const val = String(src[f] || '').trim();
            if (!val) return '<td></td>';
            const uriParam = val.match(/^CELEX:/i) ? val : 'CELEX:' + val;
            const url = 'https://eur-lex.europa.eu/legal-content/EN-SK-CS/TXT/?fromTab=ALL&from=SK&uri=' + encodeURIComponent(uriParam);
            const display = val.replace(/^CELEX:/i, '');
            const indexName = h._index || '';
            return `<td><a href="${url}" target="_blank" rel="noopener noreferrer" title="Source: ${escapeHtml(indexName)}">${escapeHtml(display)}</a></td>`;
          }
          const cellText = pretty(src[f]);
          return `<td>${document.getElementById('highlightToggle').checked ? highlight(cellText, query) : escapeHtml(cellText)}</td>`;
        }).join('') + '</tr>';
      }

      html += '</tbody></table>';
      resultsDiv.innerHTML = html;
    }

    function pretty(v) {
      if (v === null || v === undefined) return '';
      if (typeof v === 'object') return JSON.stringify(v);
      return String(v);
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function escapeRegExp(str) {
      return String(str).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function highlight(text, term) {
      if (!term || !text) return escapeHtml(text || '');

      // 1. Create a regex that handles word boundaries intelligently.
      const searchWords = String(term).split(/\s+/).filter(Boolean).map(word => {
        const escaped = escapeRegExp(word);
        // Use word boundaries only if the search term is a simple word.
        return /^\w+$/.test(word) ? `\\b${escaped}\\b` : escaped;
      });

      if (searchWords.length === 0) return escapeHtml(text);
      const regex = new RegExp(`(${searchWords.join('|')})`, 'gi');

      // 2. Replace matches with <mark> tags around the original, unescaped text.
      const highlightedText = text.replace(regex, '<mark>$1</mark>');

      // 3. Escape the entire string, then "un-escape" only the mark tags.
      return escapeHtml(highlightedText).replace(/&lt;mark&gt;/g, '<mark>').replace(/&lt;\/mark&gt;/g, '</mark>');
    }

    function generateFingerprint() {
      const components = [
        navigator.userAgent,
        navigator.language,
        screen.width,
        screen.height,
        new Date().getTimezoneOffset()
      ];
      const joined = components.join('###');
      let hash = 0;
      for (let i = 0; i < joined.length; i++) {
        const char = joined.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash |= 0; // Convert to 32bit integer
      }
      return 'fp_' + String(Math.abs(hash));
    }

    async function displayUserInfo() {
      const userInfoDiv = document.getElementById('userInfoBox');
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        userIP = data.ip;
      } catch (e) {
        console.error('Could not fetch IP address.', e);
      }

      const info = `
        <div><strong>IP:</strong> ${userIP}</div>
        <div><strong>User-Agent:</strong> ${navigator.userAgent}</div>
        <div><strong>Screen:</strong> ${screen.width}x${screen.height}</div>
        <div><strong>Language:</strong> ${navigator.language}</div>
      `;
      userInfoDiv.innerHTML = info;
    }
    
    // On page load, get user info and generate fingerprint
    (async () => {
      userFingerprint = generateFingerprint();
      await displayUserInfo();
    })();
  </script>
</body>

</html>